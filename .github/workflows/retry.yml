name: oci-instance-request-engine
on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

concurrency:
  group: oci-auto-retry
  cancel-in-progress: true

jobs:
  request:
    runs-on: ubuntu-latest
    steps:
      - name: Install and Configure OCI CLI
        run: |
          pip install oci-cli
          mkdir -p ~/.oci
          echo "${{ secrets.OCI_CONFIG_KEY }}" > ~/.oci/oci_api_key.pem
          chmod 600 ~/.oci/oci_api_key.pem
          echo "[DEFAULT]" > ~/.oci/config
          echo "user=${{ secrets.OCI_CONFIG_USER }}" >> ~/.oci/config
          echo "fingerprint=${{ secrets.OCI_CONFIG_FINGERPRINT }}" >> ~/.oci/config
          echo "tenancy=${{ secrets.OCI_CONFIG_TENANCY }}" >> ~/.oci/config
          echo "region=ap-tokyo-1" >> ~/.oci/config
          echo "key_file=${HOME}/.oci/oci_api_key.pem" >> ~/.oci/config

      - name: Execute State Machine
        run: |
          set +e
          export TZ=Asia/Tokyo
          
          SHAPES=("VM.Standard.A1.Flex" "VM.Standard.E4.Flex")
          ADS=("Uocm:AP-TOKYO-1-AD-1" "Uocm:AP-TOKYO-1-AD-2" "Uocm:AP-TOKYO-1-AD-3")
          STACK_ID="${{ secrets.OCI_CONFIG_STACK_ID }}"
          
          shape_idx=0; ad_idx=0; retry_count=0; MAX_RETRY=2
          LOG_REPORT=""; LAST_SHAPE=""; LAST_AD=""

          while true; do
            CURRENT_SHAPE="${SHAPES[$shape_idx]}"
            CURRENT_AD="${ADS[$ad_idx]}"
            LAST_SHAPE="$CURRENT_SHAPE"; LAST_AD="$CURRENT_AD"
            TIMESTAMP=$(date "+%Y-%m-%d %H:%M:%S")

            echo "[$TIMESTAMP] Start: $CURRENT_SHAPE in $CURRENT_AD"

            # ä¿®æ­£ï¼šJSONã®å¼•ç”¨ç¬¦ãƒˆãƒ©ãƒ–ãƒ«ã‚’é¿ã‘ã‚‹ãŸã‚ã€ãƒ•ã‚¡ã‚¤ãƒ«çµŒç”±ã§æ¸¡ã™
            echo "{\"instance_shape\": \"$CURRENT_SHAPE\", \"availability_domain\": \"$CURRENT_AD\"}" > params.json

            RESPONSE=$(oci resource-manager job create-apply-job \
              --stack-id "$STACK_ID" \
              --execution-plan-strategy "AUTO_APPROVED" \
              --variables file://params.json 2>&1)
            
            EXIT_CODE=$?

            if [ $EXIT_CODE -eq 0 ]; then
              JOB_ID=$(echo "$RESPONSE" | jq -r '.data.id // empty' 2>/dev/null)
              if [ ! -z "$JOB_ID" ]; then
                 echo "[$TIMESTAMP] SUCCESS: Instance provisioned (Job ID: $JOB_ID)"; exit 0
              fi
            fi

            STATUS=$(echo "$RESPONSE" | grep -o "ServiceError" || echo "")
            
            if [[ "$RESPONSE" == *"401"* ]] || [[ "$RESPONSE" == *"403"* ]]; then
               echo "[$TIMESTAMP] ERROR: Auth issue details below:"
               echo "$RESPONSE"
               exit 1
            fi

            if [[ "$RESPONSE" == *"Out of host capacity"* ]] || [[ "$RESPONSE" == *"LimitExceeded"* ]]; then
               CODE="OutOfCapacity"
            elif [[ "$RESPONSE" == *"TooManyRequests"* ]] || [[ "$RESPONSE" == *"429"* ]]; then
               CODE="RateLimit"
            elif [[ "$RESPONSE" == *"IncorrectState"* ]]; then
               CODE="IncorrectState"
            else
               CODE="UnknownError"
               SHORT_ERR=$(echo "$RESPONSE" | head -n 3)
            fi
            
            LOG_REPORT="${LOG_REPORT}  - ${CURRENT_SHAPE} / ${CURRENT_AD} : ${CODE} : ${SHORT_ERR}\n"

            case "$CODE" in
              RateLimit) echo "[$TIMESTAMP] HALT: Rate limited."; break ;;
              OutOfCapacity) ad_idx=$((ad_idx + 1)); retry_count=0 ;;
              IncorrectState|UnknownError)
                retry_count=$((retry_count + 1))
                if [ $retry_count -gt $MAX_RETRY ]; then ad_idx=$((ad_idx + 1)); retry_count=0
                else echo "[$TIMESTAMP] RETRY: Wait 30s..."; sleep 30; continue; fi ;;
              *) echo "[$TIMESTAMP] HALT: Fatal error."; break ;;
            esac

            if [ $ad_idx -ge ${#ADS[@]} ]; then ad_idx=0; shape_idx=$((shape_idx + 1)); fi
            if [ $shape_idx -ge ${#SHAPES[@]} ]; then break; fi
          done
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ æ’¤é€€å ±å‘Š (Withdrawal Report)"
          echo -e "$LOG_REPORT"
          echo "  - æœ€çµ‚åˆ°é”: ${LAST_SHAPE} in ${LAST_AD}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
