name: oci-instance-request-engine
on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

concurrency:
  group: oci-auto-retry
  cancel-in-progress: true

jobs:
  request:
    runs-on: ubuntu-latest
    steps:
      - name: Install and Configure OCI CLI
        run: |
          pip install oci-cli
          mkdir -p ~/.oci
          # ç§˜å¯†éµã‚’æ›¸ãå‡ºã—
          echo "${{ secrets.OCI_CONFIG_KEY }}" > ~/.oci/oci_api_key.pem
          chmod 600 ~/.oci/oci_api_key.pem
          # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
          echo "[DEFAULT]" > ~/.oci/config
          echo "user=${{ secrets.OCI_CONFIG_USER }}" >> ~/.oci/config
          echo "fingerprint=${{ secrets.OCI_CONFIG_FINGERPRINT }}" >> ~/.oci/config
          echo "tenancy=${{ secrets.OCI_CONFIG_TENANCY }}" >> ~/.oci/config
          echo "region=ap-tokyo-1" >> ~/.oci/config
          echo "key_file=${HOME}/.oci/oci_api_key.pem" >> ~/.oci/config

      - name: Execute State Machine (Debug)
        run: |
          # ã‚¯ãƒ©ãƒƒã‚·ãƒ¥é˜²æ­¢ï¼šå³æ ¼ãƒ¢ãƒ¼ãƒ‰ã‚’ã‚ªãƒ•ã«ã™ã‚‹
          set +e
          export TZ=Asia/Tokyo
          export PATH=$PATH:$HOME/.local/bin
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” è¨ºæ–­ãƒ¢ãƒ¼ãƒ‰èµ·å‹•"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # 1. éµãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­èº«ãƒã‚§ãƒƒã‚¯ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚å…ˆé ­ã¨æœ«å°¾ã ã‘è¡¨ç¤ºï¼‰
          echo "Checking Key Format..."
          FIRST_LINE=$(head -n 1 ~/.oci/oci_api_key.pem)
          LAST_LINE=$(tail -n 1 ~/.oci/oci_api_key.pem)
          echo "  Header: $FIRST_LINE"
          echo "  Footer: $LAST_LINE"
          
          if [[ "$FIRST_LINE" != *"BEGIN"* ]]; then
             echo "âš ï¸ è­¦å‘Š: ç§˜å¯†éµã®é–‹å§‹è¡ŒãŒãŠã‹ã—ã„ã‚ˆã†ã§ã™ã€‚"
          fi

          # 2. çŠ¶æ…‹æ©Ÿæ¢°ãƒ«ãƒ¼ãƒ—
          SHAPES=("VM.Standard.A1.Flex" "VM.Standard.E4.Flex")
          ADS=("Uocm:AP-TOKYO-1-AD-1" "Uocm:AP-TOKYO-1-AD-2" "Uocm:AP-TOKYO-1-AD-3")
          STACK_ID="${{ secrets.OCI_CONFIG_STACK_ID }}"
          
          shape_idx=0; ad_idx=0; retry_count=0; MAX_RETRY=2
          LOG_REPORT=""; LAST_SHAPE=""; LAST_AD=""

          while true; do
            CURRENT_SHAPE="${SHAPES[$shape_idx]}"
            CURRENT_AD="${ADS[$ad_idx]}"
            LAST_SHAPE="$CURRENT_SHAPE"; LAST_AD="$CURRENT_AD"
            TIMESTAMP=$(date "+%Y-%m-%d %H:%M:%S")

            echo "[$TIMESTAMP] Start: $CURRENT_SHAPE in $CURRENT_AD"

            # ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œçµæœã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã—ã¦è§£æï¼ˆã‚¯ãƒ©ãƒƒã‚·ãƒ¥å›é¿ï¼‰
            oci resource-manager job create-apply-job --stack-id "$STACK_ID" --availability-domain "$CURRENT_AD" --shape "$CURRENT_SHAPE" > response.log 2>&1
            EXIT_CODE=$?
            RESPONSE=$(cat response.log)

            # è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯å³åº§ã«è©³ç´°ã‚’è¡¨ç¤º
            if [ $EXIT_CODE -ne 0 ]; then
               STATUS_CHECK=$(echo "$RESPONSE" | grep -o "ServiceError")
               if [ -z "$STATUS_CHECK" ] && [[ "$RESPONSE" != *"ocid1.ormjob"* ]]; then
                  echo "âŒ OCI CLI ERROR details:"
                  echo "$RESPONSE"
               fi
            fi

            if [ $EXIT_CODE -eq 0 ]; then
              JOB_ID=$(echo "$RESPONSE" | jq -r '.data.id // empty' 2>/dev/null)
              echo "[$TIMESTAMP] SUCCESS: Instance provisioned (ID: $JOB_ID)"; exit 0
            fi

            STATUS=$(echo "$RESPONSE" | jq -r '.status // empty' 2>/dev/null)
            CODE=$(echo "$RESPONSE" | jq -r '.code // empty' 2>/dev/null)
            
            if [ -z "$STATUS" ]; then 
               STATUS="NON_JSON"
               # ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šJSONã˜ã‚ƒãªã„ã‚¨ãƒ©ãƒ¼ï¼ˆè¨­å®šãƒŸã‚¹ãªã©ï¼‰ãªã‚‰ãƒ«ãƒ¼ãƒ—ã‚’æŠœã‘ã‚‹
               if [[ "$RESPONSE" == *"config"* ]] || [[ "$RESPONSE" == *"PEM"* ]]; then
                  echo "[$TIMESTAMP] CONFIG ERROR: $RESPONSE"
                  exit 1
               fi
            fi

            LOG_REPORT="${LOG_REPORT}  - ${CURRENT_SHAPE} / ${CURRENT_AD} : ${STATUS}:${CODE}\n"

            case "$STATUS:$CODE" in
              401:*|403:*) echo "[$TIMESTAMP] ERROR: Auth issue."; exit 1 ;;
              429:*) echo "[$TIMESTAMP] HALT: Rate limited."; break ;;
              409:OutOfCapacity|409:LimitExceeded) ad_idx=$((ad_idx + 1)); retry_count=0 ;;
              409:IncorrectState|5*:*|NON_JSON:*)
                retry_count=$((retry_count + 1))
                if [ $retry_count -gt $MAX_RETRY ]; then ad_idx=$((ad_idx + 1)); retry_count=0
                else echo "[$TIMESTAMP] RETRY: Wait 30s..."; sleep 30; continue; fi ;;
              409:Conflict) echo "[$TIMESTAMP] HALT: Stack Conflict."; break ;;
              *) echo "[$TIMESTAMP] HALT: Unknown error."; break ;;
            esac

            if [ $ad_idx -ge ${#ADS[@]} ]; then ad_idx=0; shape_idx=$((shape_idx + 1)); fi
            if [ $shape_idx -ge ${#SHAPES[@]} ]; then break; fi
          done
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ æ’¤é€€å ±å‘Š (Withdrawal Report)"
          echo "  - æœ€çµ‚åˆ°é”: ${LAST_SHAPE} in ${LAST_AD}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
