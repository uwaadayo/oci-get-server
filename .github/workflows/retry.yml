name: oci-instance-request-engine
on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

concurrency:
  group: oci-auto-retry
  cancel-in-progress: true

jobs:
  request:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    steps:
      - name: Install and Configure OCI CLI manually
        run: |
          set -e
          # ã€ä¿®æ­£1ã€‘umaskã§æ¨©é™ã‚’æœ€åˆã‹ã‚‰çµã‚‹
          (umask 077; echo "${{ secrets.OCI_CONFIG_KEY }}" > oci_api_key.pem)
          
          mkdir -p ~/.oci
          mv oci_api_key.pem ~/.oci/
          
          echo "[DEFAULT]" > ~/.oci/config
          echo "user=${{ secrets.OCI_CONFIG_USER }}" >> ~/.oci/config
          echo "fingerprint=${{ secrets.OCI_CONFIG_FINGERPRINT }}" >> ~/.oci/config
          echo "tenancy=${{ secrets.OCI_CONFIG_TENANCY }}" >> ~/.oci/config
          echo "region=ap-tokyo-1" >> ~/.oci/config
          echo "key_file=${HOME}/.oci/oci_api_key.pem" >> ~/.oci/config
          
          pip install oci-cli
          
          command -v jq >/dev/null 2>&1 || { echo "âŒ Critical: jq is not installed."; exit 1; }
          command -v oci >/dev/null 2>&1 || { echo "âŒ Critical: OCI CLI install failed."; exit 1; }

      - name: Execute Tactical Strategy
        run: |
          set +e
          export TZ=Asia/Tokyo
          export SUPPRESS_LABEL_WARNING=True
          export OCI_CLI_SUPPRESS_FILE_PERMISSIONS_WARNING=True
          
          STACK_ID="${{ secrets.OCI_CONFIG_STACK_ID }}"
          
          SHAPES=("VM.Standard.A1.Flex" "VM.Standard.E4.Flex")
          declare -A AD_PRIORITY
          AD_PRIORITY["VM.Standard.A1.Flex"]="Uocm:AP-TOKYO-1-AD-3 Uocm:AP-TOKYO-1-AD-2 Uocm:AP-TOKYO-1-AD-1"
          AD_PRIORITY["VM.Standard.E4.Flex"]="Uocm:AP-TOKYO-1-AD-2 Uocm:AP-TOKYO-1-AD-3 Uocm:AP-TOKYO-1-AD-1"

          RATE_LIMIT_WAIT=30
          START_TIME=$(date +%s)
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ›¡ï¸ OCI AUTO-PILOT v5.2.0 (Refined & Secure)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          while true; do
            CURRENT_TIME=$(date +%s)
            ELAPSED=$((CURRENT_TIME - START_TIME))
            REMAINING=$((21600 - ELAPSED))
            
            if [ $REMAINING -lt 120 ]; then
              echo "ğŸ›‘ Maintenance: Exiting gracefully."
              exit 0
            fi

            for shape in "${SHAPES[@]}"; do
              read -r -a CURRENT_ADS <<< "${AD_PRIORITY[$shape]}"
              
              for ad in "${CURRENT_ADS[@]}"; do
                
                # Check for running jobs
                RUNNING_JOB=$(oci resource-manager job list \
                  --stack-id "$STACK_ID" \
                  --lifecycle-state IN_PROGRESS \
                  --query 'data[0].id' \
                  --raw-output 2>/dev/null)

                if [ -n "$RUNNING_JOB" ] && [ "$RUNNING_JOB" != "null" ]; then
                  TIMESTAMP=$(date "+%H:%M:%S")
                  echo "â¸ï¸ [${TIMESTAMP}] Job active ($RUNNING_JOB). Standby..."
                  sleep 30
                  continue
                fi

                TIMESTAMP=$(date "+%H:%M:%S")
                echo "âš”ï¸ [${TIMESTAMP}] Target: $shape @ $ad"
                
                # ã€ä¿®æ­£2ã€‘JSONã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãå‡ºã—ã€CLIã«ã¯ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’æ¸¡ã™
                jq -n --arg shape "$shape" --arg ad "$ad" \
                  '{"instance_shape": $shape, "availability_domain": $ad}' > params.json

                RESPONSE=$(oci resource-manager job create-apply-job \
                  --stack-id "$STACK_ID" \
                  --execution-plan-strategy "AUTO_APPROVED" \
                  --variables file://params.json 2>&1)
                
                EXIT_CODE=$?

                if [ $EXIT_CODE -eq 0 ]; then
                  JOB_ID=$(echo "$RESPONSE" | jq -r '.data.id // empty' 2>/dev/null)
                  if [ -n "$JOB_ID" ]; then
                    echo "ğŸ‰ SUCCESS: Provisioning started! Job ID: $JOB_ID"
                    echo "## ğŸš€ Oracle Cloud Server Secured!" >> $GITHUB_STEP_SUMMARY
                    echo "**Shape**: $shape" >> $GITHUB_STEP_SUMMARY
                    echo "**AD**: $ad" >> $GITHUB_STEP_SUMMARY
                    echo "**Job ID**: $JOB_ID" >> $GITHUB_STEP_SUMMARY
                    exit 0
                  fi
                fi

                ERROR_CODE=$(echo "$RESPONSE" | jq -r '.code // "Unknown"' 2>/dev/null)
                
                if [ "$ERROR_CODE" == "Unknown" ] || [ "$ERROR_CODE" == "null" ]; then
                   if [[ "$RESPONSE" == *"429"* ]] || [[ "$RESPONSE" == *"TooManyRequests"* ]]; then ERROR_CODE="TooManyRequests"; fi
                   if [[ "$RESPONSE" == *"401"* ]] || [[ "$RESPONSE" == *"NotAuthenticated"* ]]; then ERROR_CODE="NotAuthenticated"; fi
                   if [[ "$RESPONSE" == *"Out of host capacity"* ]]; then ERROR_CODE="OutOfCapacity"; fi
                fi

                case "$ERROR_CODE" in
                  NotAuthenticated|401)
                    echo "âŒ Critical: Authentication failed."
                    exit 1 ;;
                  TooManyRequests|429)
                    echo "âš ï¸ Rate Limit. Sleep ${RATE_LIMIT_WAIT}s..."
                    sleep $RATE_LIMIT_WAIT
                    RATE_LIMIT_WAIT=$((RATE_LIMIT_WAIT * 2))
                    if [ $RATE_LIMIT_WAIT -gt 300 ]; then RATE_LIMIT_WAIT=300; fi
                    ;;
                  OutOfCapacity|LimitExceeded)
                    echo "ğŸ“‰ Full. Next."
                    RATE_LIMIT_WAIT=30
                    ;;
                  *)
                    echo "âš ï¸ Status: $ERROR_CODE"
                    sleep 5 # ã€ä¿®æ­£3ã€‘é€šå¸¸ã‚¨ãƒ©ãƒ¼æ™‚ã®Waitã‚’çŸ­ç¸®
                    ;;
                esac
                
                sleep 5 
              done
            done
            sleep 1
          done
