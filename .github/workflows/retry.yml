name: oci-instance-request-engine
on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

concurrency:
  group: oci-auto-retry
  cancel-in-progress: true

jobs:
  request:
    runs-on: ubuntu-latest
    steps:
      # ã€æ”¹å–„ã€‘pip installã‚’ã‚„ã‚ã€å…¬å¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã§å®‰å®šåŒ–ã¨é«˜é€ŸåŒ–ã‚’å›³ã‚‹
      - name: Setup OCI CLI
        uses: oracle-actions/setup-oci-cli@v1.1.1
        with:
          user: ${{ secrets.OCI_CONFIG_USER }}
          fingerprint: ${{ secrets.OCI_CONFIG_FINGERPRINT }}
          tenancy: ${{ secrets.OCI_CONFIG_TENANCY }}
          region: "ap-tokyo-1"
          api_key: ${{ secrets.OCI_CONFIG_KEY }}

      - name: Execute Provisioning Strategy
        run: |
          # ã‚¨ãƒ©ãƒ¼ã§å³åœæ­¢ã›ãšã€ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’è‡ªå‰ã§è¡Œã†
          set +e
          export TZ=Asia/Tokyo
          
          # å®šæ•°å®šç¾©
          STACK_ID="${{ secrets.OCI_CONFIG_STACK_ID }}"
          SHAPES=("VM.Standard.A1.Flex" "VM.Standard.E4.Flex")
          ADS=("Uocm:AP-TOKYO-1-AD-1" "Uocm:AP-TOKYO-1-AD-2" "Uocm:AP-TOKYO-1-AD-3")
          MAX_RETRY=2

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ Provisioning Sequence Started"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # ã€æ§‹é€ æ”¹é©ã€‘ç„¡é™ãƒ«ãƒ¼ãƒ—ã‚’å»ƒæ­¢ã—ã€äºˆæ¸¬å¯èƒ½ãª3é‡ãƒ«ãƒ¼ãƒ—ã¸å¤‰æ›´
          for shape in "${SHAPES[@]}"; do
            for ad in "${ADS[@]}"; do
              
              echo "ğŸ¯ Target: $shape in $ad"
              
              # ã€å®‰å…¨æ€§ã€‘Stack Updateã‚’å»ƒæ­¢ã€‚å¤‰æ•°ã¯ãƒ•ã‚¡ã‚¤ãƒ«çµŒç”±ã§ã‚¸ãƒ§ãƒ–ã«ç›´æ¥æ³¨å…¥ã™ã‚‹
              # ã“ã‚Œã«ã‚ˆã‚Šã‚¹ã‚¿ãƒƒã‚¯æœ¬ä½“ã®ãƒ­ãƒƒã‚¯(IncorrectState)ã‚’å›é¿
              jq -n --arg shape "$shape" --arg ad "$ad" \
                '{"instance_shape": $shape, "availability_domain": $ad}' > params.json

              # ãƒªãƒˆãƒ©ã‚¤ãƒ«ãƒ¼ãƒ—
              for (( i=1; i<=MAX_RETRY; i++ )); do
                TIMESTAMP=$(date "+%H:%M:%S")
                
                # ã‚¸ãƒ§ãƒ–å®Ÿè¡Œï¼ˆå¤‰æ•°ã‚’æ³¨å…¥ã—ãªãŒã‚‰Applyï¼‰
                RESPONSE=$(oci resource-manager job create-apply-job \
                  --stack-id "$STACK_ID" \
                  --execution-plan-strategy "AUTO_APPROVED" \
                  --variables file://params.json 2>&1)
                
                EXIT_CODE=$?

                # ã€å …ç‰¢åŒ–ã€‘JSONãƒ‘ãƒ¼ã‚¹ã«ã‚ˆã‚‹å³å¯†ãªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¤å®š
                if [ $EXIT_CODE -eq 0 ]; then
                  JOB_ID=$(echo "$RESPONSE" | jq -r '.data.id // empty')
                  if [ -n "$JOB_ID" ]; then
                    echo "[$TIMESTAMP] âœ… SUCCESS: Job created successfully! (ID: $JOB_ID)"
                    # æˆåŠŸã—ãŸã‚‰å…¨ãƒ«ãƒ¼ãƒ—ã‚’æŠœã‘ã¦çµ‚äº†
                    exit 0
                  fi
                fi

                # ã‚¨ãƒ©ãƒ¼è§£æ
                HTTP_STATUS=$(echo "$RESPONSE" | jq -r '.status // "000"' 2>/dev/null)
                ERROR_CODE=$(echo "$RESPONSE" | jq -r '.code // "Unknown"' 2>/dev/null)
                
                # JSONãƒ‘ãƒ¼ã‚¹å¤±æ•—æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆCLIãŒç”Ÿãƒ†ã‚­ã‚¹ãƒˆã‚’åã„ãŸå ´åˆï¼‰
                if [ "$ERROR_CODE" == "Unknown" ]; then
                   if [[ "$RESPONSE" == *"429"* ]] || [[ "$RESPONSE" == *"TooManyRequests"* ]]; then ERROR_CODE="TooManyRequests"; fi
                   if [[ "$RESPONSE" == *"401"* ]] || [[ "$RESPONSE" == *"NotAuthenticated"* ]]; then ERROR_CODE="NotAuthenticated"; fi
                   if [[ "$RESPONSE" == *"Out of host capacity"* ]]; then ERROR_CODE="OutOfCapacity"; fi
                fi

                echo "   Attempt $i/$MAX_RETRY: [$HTTP_STATUS] $ERROR_CODE"

                # ã€æˆ¦ç•¥åˆ†å²ã€‘ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã«åŸºã¥ãåˆ¤æ–­
                case "$ERROR_CODE" in
                  # èªè¨¼ã‚¨ãƒ©ãƒ¼ï¼šã“ã‚Œä»¥ä¸Šã‚„ã£ã¦ã‚‚ç„¡é§„ãªã®ã§å³æ­»ã•ã›ã‚‹
                  NotAuthenticated|401)
                    echo "âŒ Critical Error: Authentication failed."
                    echo "$RESPONSE"
                    exit 1
                    ;;
                  
                  # ãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼šå°‘ã—å¾…ã£ã¦ãƒªãƒˆãƒ©ã‚¤ï¼ˆãƒ«ãƒ¼ãƒ—ã¯ç¶™ç¶šï¼‰
                  TooManyRequests|429)
                    echo "âš ï¸ Rate Limited. Cooling down..."
                    sleep 60
                    continue
                    ;;
                  
                  # å®¹é‡ä¸è¶³ï¼šã“ã®AD/Shapeã¯è«¦ã‚ã¦æ¬¡ã®ADã¸ï¼ˆbreakã—ã¦å†…å´ãƒ«ãƒ¼ãƒ—ã‚’æŠœã‘ã‚‹ï¼‰
                  OutOfCapacity|LimitExceeded)
                    echo "ğŸ“‰ Out of Capacity. Moving to next target."
                    break 1 
                    ;;
                  
                  # ã‚¹ã‚¿ãƒƒã‚¯ç«¶åˆãƒ»çŠ¶æ…‹ä¸æ­£ï¼šä¸€æ™‚çš„ãªã‚‚ã®ãªã®ã§ãƒªãƒˆãƒ©ã‚¤
                  IncorrectState|Conflict)
                    if [ $i -lt $MAX_RETRY ]; then
                      echo "ğŸ”„ State Conflict. Retrying in 30s..."
                      sleep 30
                    fi
                    ;;
                    
                  # ãã®ä»–ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ï¼šè©³ç´°ã‚’å‡ºã—ã¦ãƒªãƒˆãƒ©ã‚¤
                  *)
                    echo "âš ï¸ Unknown Error occurred."
                    if [ $i -lt $MAX_RETRY ]; then sleep 30; fi
                    ;;
                esac
              done # Retry Loop
            done # AD Loop
          done # Shape Loop

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ All attempts finished without success."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          exit 0
