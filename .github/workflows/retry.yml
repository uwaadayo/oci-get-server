name: oci-instance-request-engine
on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

concurrency:
  group: oci-auto-retry
  cancel-in-progress: true

jobs:
  request:
    runs-on: ubuntu-latest
    steps:
      - name: Install and Configure OCI CLI
        run: |
          pip install oci-cli
          mkdir -p ~/.oci
          # 秘密鍵を書き出し
          echo "${{ secrets.OCI_CONFIG_KEY }}" > ~/.oci/oci_api_key.pem
          chmod 600 ~/.oci/oci_api_key.pem
          # 設定ファイル作成
          echo "[DEFAULT]" > ~/.oci/config
          echo "user=${{ secrets.OCI_CONFIG_USER }}" >> ~/.oci/config
          echo "fingerprint=${{ secrets.OCI_CONFIG_FINGERPRINT }}" >> ~/.oci/config
          echo "tenancy=${{ secrets.OCI_CONFIG_TENANCY }}" >> ~/.oci/config
          echo "region=ap-tokyo-1" >> ~/.oci/config
          echo "key_file=${HOME}/.oci/oci_api_key.pem" >> ~/.oci/config

      - name: Execute State Machine
        run: |
          set +e
          export TZ=Asia/Tokyo
          
          # シェイプとADのリスト
          SHAPES=("VM.Standard.A1.Flex" "VM.Standard.E4.Flex")
          ADS=("Uocm:AP-TOKYO-1-AD-1" "Uocm:AP-TOKYO-1-AD-2" "Uocm:AP-TOKYO-1-AD-3")
          STACK_ID="${{ secrets.OCI_CONFIG_STACK_ID }}"
          
          shape_idx=0; ad_idx=0; retry_count=0; MAX_RETRY=2
          LOG_REPORT=""; LAST_SHAPE=""; LAST_AD=""

          while true; do
            CURRENT_SHAPE="${SHAPES[$shape_idx]}"
            CURRENT_AD="${ADS[$ad_idx]}"
            LAST_SHAPE="$CURRENT_SHAPE"; LAST_AD="$CURRENT_AD"
            TIMESTAMP=$(date "+%Y-%m-%d %H:%M:%S")

            echo "[$TIMESTAMP] Start: $CURRENT_SHAPE in $CURRENT_AD"

            # 修正箇所：変数をJSON形式で渡すように変更
            # Terraformの変数名（instance_shape, availability_domain）に合わせています
            VARIABLES_JSON="{\"instance_shape\": \"$CURRENT_SHAPE\", \"availability_domain\": \"$CURRENT_AD\"}"

            # コマンド実行（自動承認モードを追加）
            RESPONSE=$(oci resource-manager job create-apply-job \
              --stack-id "$STACK_ID" \
              --execution-plan-strategy "AUTO_APPROVED" \
              --variables "$VARIABLES_JSON" 2>&1)
