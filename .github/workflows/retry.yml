name: oci-instance-request-engine
on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

concurrency:
  group: oci-auto-retry
  cancel-in-progress: true

jobs:
  request:
    runs-on: ubuntu-latest
    steps:
      # ã€ä¿®æ­£ã€‘å…¬å¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ã‚ãšã€ç¢ºå®Ÿãªæ‰‹å‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«æˆ»ã—ã¾ã—ãŸ
      - name: Install and Configure OCI CLI manually
        run: |
          pip install oci-cli
          mkdir -p ~/.oci
          echo "${{ secrets.OCI_CONFIG_KEY }}" > ~/.oci/oci_api_key.pem
          chmod 600 ~/.oci/oci_api_key.pem
          echo "[DEFAULT]" > ~/.oci/config
          echo "user=${{ secrets.OCI_CONFIG_USER }}" >> ~/.oci/config
          echo "fingerprint=${{ secrets.OCI_CONFIG_FINGERPRINT }}" >> ~/.oci/config
          echo "tenancy=${{ secrets.OCI_CONFIG_TENANCY }}" >> ~/.oci/config
          echo "region=ap-tokyo-1" >> ~/.oci/config
          echo "key_file=${HOME}/.oci/oci_api_key.pem" >> ~/.oci/config

      - name: Execute Provisioning Strategy
        run: |
          set +e
          export TZ=Asia/Tokyo
          # ä½™è¨ˆãªè­¦å‘Šã‚’æ¶ˆã—ã¦ã€JSONè§£æã‚’é‚ªé­”ã•ã›ãªã„
          export SUPPRESS_LABEL_WARNING=True
          export OCI_CLI_SUPPRESS_FILE_PERMISSIONS_WARNING=True
          
          # å®šæ•°å®šç¾©
          STACK_ID="${{ secrets.OCI_CONFIG_STACK_ID }}"
          SHAPES=("VM.Standard.A1.Flex" "VM.Standard.E4.Flex")
          ADS=("Uocm:AP-TOKYO-1-AD-1" "Uocm:AP-TOKYO-1-AD-2" "Uocm:AP-TOKYO-1-AD-3")
          MAX_RETRY=2

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ Provisioning Sequence Started (v3.1.0)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # 3é‡ãƒ«ãƒ¼ãƒ—æ§‹é€ ï¼ˆShape > AD > Retryï¼‰
          for shape in "${SHAPES[@]}"; do
            for ad in "${ADS[@]}"; do
              
              echo "ğŸ¯ Target: $shape in $ad"
              
              # ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ
              jq -n --arg shape "$shape" --arg ad "$ad" \
                '{"instance_shape": $shape, "availability_domain": $ad}' > params.json

              # ãƒªãƒˆãƒ©ã‚¤ãƒ«ãƒ¼ãƒ—
              for (( i=1; i<=MAX_RETRY; i++ )); do
                TIMESTAMP=$(date "+%H:%M:%S")
                
                # ã‚¸ãƒ§ãƒ–å®Ÿè¡Œ
                RESPONSE=$(oci resource-manager job create-apply-job \
                  --stack-id "$STACK_ID" \
                  --execution-plan-strategy "AUTO_APPROVED" \
                  --variables file://params.json 2>&1)
                
                EXIT_CODE=$?

                # æˆåŠŸåˆ¤å®š
                if [ $EXIT_CODE -eq 0 ]; then
                  JOB_ID=$(echo "$RESPONSE" | jq -r '.data.id // empty' 2>/dev/null)
                  if [ -n "$JOB_ID" ]; then
                    echo "[$TIMESTAMP] âœ… SUCCESS: Job created successfully! (ID: $JOB_ID)"
                    exit 0
                  fi
                fi

                # ã‚¨ãƒ©ãƒ¼è§£æ
                HTTP_STATUS=$(echo "$RESPONSE" | jq -r '.status // "000"' 2>/dev/null)
                ERROR_CODE=$(echo "$RESPONSE" | jq -r '.code // "Unknown"' 2>/dev/null)
                
                # JSONãƒ‘ãƒ¼ã‚¹å¤±æ•—æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                if [ "$ERROR_CODE" == "Unknown" ] || [ "$ERROR_CODE" == "null" ]; then
                   if [[ "$RESPONSE" == *"429"* ]] || [[ "$RESPONSE" == *"TooManyRequests"* ]]; then ERROR_CODE="TooManyRequests"; fi
                   if [[ "$RESPONSE" == *"401"* ]] || [[ "$RESPONSE" == *"NotAuthenticated"* ]]; then ERROR_CODE="NotAuthenticated"; fi
                   if [[ "$RESPONSE" == *"Out of host capacity"* ]]; then ERROR_CODE="OutOfCapacity"; fi
                fi

                echo "   Attempt $i/$MAX_RETRY: [$HTTP_STATUS] $ERROR_CODE"

                # æˆ¦ç•¥åˆ†å²
                case "$ERROR_CODE" in
                  NotAuthenticated|401)
                    echo "âŒ Critical Error: Authentication failed."
                    echo "$RESPONSE"
                    exit 1
                    ;;
                  TooManyRequests|429)
                    echo "âš ï¸ Rate Limited. Cooling down..."
                    sleep 60
                    continue
                    ;;
                  OutOfCapacity|LimitExceeded)
                    echo "ğŸ“‰ Out of Capacity. Moving to next target."
                    break 1 
                    ;;
                  IncorrectState|Conflict)
                    if [ $i -lt $MAX_RETRY ]; then
                      echo "ğŸ”„ State Conflict. Retrying in 30s..."
                      sleep 30
                    fi
                    ;;
                  *)
                    echo "âš ï¸ Unknown Error or Wait."
                    if [ $i -lt $MAX_RETRY ]; then sleep 30; fi
                    ;;
                esac
              done # Retry Loop
            done # AD Loop
          done # Shape Loop

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ All attempts finished without success."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          exit 0
